#!/bin/bash

SSH_DIR="$SNAP_COMMON/.ssh"
SSH_KEY="${SSH_DIR}/ssh-tunnel-key"

# first get settings (if there are any)
REMOTE_TARGET=$(snapctl get ssh-tunnel.remote.target)
REMOTE_FORWARDING_PORT=$(snapctl get ssh-tunnel.remote.forwarding-port)
REMOTE_SSH_PORT=$(snapctl get ssh-tunnel.remote.ssh-port)  # default 22
REMOTE_USER=$(snapctl get ssh-tunnel.remote.user)

if [[ -z "${REMOTE_TARGET}" ]] || [[ -z "${REMOTE_FORWARDING_PORT}" ]] || [[ -z "${REMOTE_USER}" ]] ; then
    # service is not configured, disable it quit
    echo "ssh tunnel is not configured, disabling service"
    snapctl stop --disable ${SNAP_INSTANCE_NAME}.ssh-tunnel || true
    exit 0
fi

[ -z "${REMOTE_SSH_PORT}" ] && REMOTE_SSH_PORT="22"

LOCAL_ADDR=$(snapctl get ssh-tunnel.local.address) # default localhost
LOCAL_PORT=$(snapctl get ssh-tunnel.local.port) # default 22

[ -z "${LOCAL_PORT}" ] && LOCAL_PORT="22"
[ -z "${LOCAL_ADDR}" ] && LOCAL_ADDR="localhost"

ssh -NT \
    -o ServerAliveInterval=60 \
    -o ExitOnForwardFailure=yes \
    -o StrictHostKeyChecking=no \
    -i ${SSH_KEY} \
    -R ${REMOTE_FORWARDING_PORT}:${LOCAL_ADDR}:${LOCAL_PORT} \
    -p ${REMOTE_SSH_PORT} \
    ${REMOTE_USER}@${REMOTE_TARGET}
